<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandeira Stay Manager</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>:root{--primary-color:#2d7a7a;--primary-dark:#1a4d4d;--accent-color:#d4a574;--text-dark:#333;--text-light:#666;--bg-light:#f5f5f5;--bg-white:#fff;--border-color:#e0e0e0;--red:#dc3545;--green:#28a745}*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:var(--bg-light);color:var(--text-dark)}.container{display:flex;min-height:100vh}.sidebar{width:260px;background:linear-gradient(180deg,var(--primary-color) 0%,var(--primary-dark) 100%);color:white;padding:24px 0;position:fixed;height:100vh;overflow-y:auto;z-index:100}.logo{display:flex;align-items:center;gap:12px;padding:0 24px 24px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:24px}.menu-item{padding:12px 24px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;font-size:14px}.menu-item:hover{background:rgba(255,255,255,.1)}.menu-item.active{background:rgba(255,255,255,.15);border-left:3px solid var(--accent-color)}.main{margin-left:260px;flex:1;padding:32px;width:calc(100% - 260px)}.page{display:none}.page.active{display:block}.page-header{margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}.page-header h2{font-size:28px;color:var(--primary-dark);font-weight:700}.card{background:var(--bg-white);border-radius:12px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:24px}.btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:var(--primary-dark);color:white}.btn-primary:hover{background:var(--primary-color)}.btn-secondary{background:var(--accent-color);color:white}.btn-link{background:none;color:var(--text-light);font-weight:500}.upload-area{border:2px dashed var(--primary-color);border-radius:12px;padding:48px;text-align:center;cursor:pointer}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;font-size:14px;font-weight:500}.form-input,.form-select{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:14px}.flex{display:flex}.gap-16{gap:16px}.flex-1{flex:1}.filter-bar{display:flex;flex-wrap:wrap;gap:16px;align-items:center}.select2-container{width:100%!important}.select2-container .select2-selection--multiple{border:1px solid var(--border-color)!important;padding:6px!important;border-radius:8px!important;min-height:48px}.indicadores-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px}.indicador-card{background:var(--bg-white);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.indicador-card.clickable{cursor:pointer;transition:transform .2s,box-shadow .2s}.indicador-card.clickable:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.08)}.indicador-label{font-size:13px;color:var(--text-light);margin-bottom:4px;text-transform:uppercase;font-weight:600}.indicador-valor{font-size:26px;font-weight:700;color:var(--primary-dark)}.indicador-valor.red{color:var(--red)}.indicador-valor.green{color:var(--green)}.indicador-chart{height:200px;margin-top:16px}.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

th, td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-color);
    white-space: nowrap;
    font-size: 12px;
    min-width: 90px;
}

td {
    text-align: right;
}

td:first-child, th:first-child {
    text-align: left;
    min-width: 160px;
}

th {
    background-color: #f8f9fa;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}.modal-overlay.active{display:flex}.modal-content{background:var(--bg-white);padding:32px;border-radius:12px;width:90%;max-width:500px}.unidade-grupo{border-top:3px solid var(--primary-dark);margin-top:16px;padding-top:0}.unidade-header{background:rgba(45,122,122,0.08);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;transition:background 0.2s;border-radius:8px 8px 0 0}.unidade-header:hover{background:rgba(45,122,122,0.12)}.unidade-nome{font-weight:700;color:var(--primary-dark);font-size:15px;display:flex;align-items:center;gap:10px}.unidade-toggle{font-size:18px;transition:transform 0.2s}.unidade-toggle.collapsed{transform:rotate(-90deg)}.unidade-conteudo{display:block}.unidade-conteudo.collapsed{display:none}.unidade-conteudo table{margin-top:0;border-radius:0 0 8px 8px}.filter-ano-pequeno{display:flex;gap:8px;align-items:center;margin-bottom:16px}.filter-ano-pequeno select{width:150px;padding:8px;border:1px solid var(--border-color);border-radius:6px;font-size:13px}.analitica-filtros{display:flex;gap:16px;align-items:center;margin-bottom:24px;flex-wrap:wrap}.analitica-filtros select{padding:10px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:14px}.analitica-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px}.analitica-card{background:var(--bg-white);border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.analitica-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}.analitica-card-icon{font-size:32px}.analitica-card-title{font-size:14px;color:var(--text-light);text-transform:uppercase;font-weight:600}.analitica-card-value{font-size:28px;font-weight:700;color:var(--primary-dark);margin-top:8px}.analitica-card-value.green{color:var(--green)}.analitica-card-value.red{color:var(--red)}.analitica-card-chart{height:150px;margin-top:16px}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 24px;
}

.logo-mark {
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo-title {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.logo-sub {
    font-size: 12px;
    opacity: 0.7;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    padding-bottom: 5px;
}

table {
    border-collapse: collapse;
    font-size: 14px;
    width: 100%;
    min-width: max-content; /* Garante que as colunas n√£o esmaguem demais */
}

.table-scroll-top {
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    height: 12px;
    margin-bottom: 4px;
    display: none;
}

.table-scroll-top .scroll-inner {
    height: 1px;
}


</style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
<div class="logo">
    <div class="logo-mark">
        <svg width="48" height="48" viewBox="0 0 64 64" fill="none"
             xmlns="http://www.w3.org/2000/svg">
            <!-- Casa -->
            <path d="M16 30L32 18L48 30V48H16V30Z"
                  stroke="white" stroke-width="3" fill="none"/>
            <path d="M28 48V36H36V48"
                  stroke="white" stroke-width="3"/>

            <!-- Coqueiro -->
            <path d="M22 18C18 10 12 8 10 8"
                  stroke="white" stroke-width="3"
                  stroke-linecap="round"/>
            <path d="M22 18C16 16 12 18 10 20"
                  stroke="white" stroke-width="3"
                  stroke-linecap="round"/>
        </svg>
    </div>

    <div class="logo-text">
        <div class="logo-title">Bandeira</div>
        <div class="logo-sub">Beach House</div>
    </div>
</div>
            <div class="menu-item active" onclick="showPage('financeiro', this)">üí∞ Financeiro</div>
            <div class="menu-item" onclick="showPage('analitica', this)">üìä Anal√≠tica</div>
            <div class="menu-item" onclick="showPage('despesas', this)">üí∏ Despesas</div>
            <div class="menu-item" onclick="showPage('reservas', this)">üßπ Reservas Futuras</div>
            <div class="menu-item" onclick="showPage('proprietarios', this)">üë§ Propriet√°rios</div>
            <div class="menu-item" onclick="showPage('upload', this)">üì§ Upload de Dados</div>
        </div>



        <div class="main">
            <div id="financeiro" class="page">
                <div class="page-header"><h2>Financeiro</h2><button class="btn btn-link" onclick="zerarFinanceiro()">/ Zerar tudo</button></div>
                <div class="card filter-bar">
                    <div class="form-group flex-1"><select id="filtroAnos" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroMeses" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroUnidades" class="form-select" multiple="multiple"></select></div>
                    <button class="btn btn-primary" onclick="renderViews()">Aplicar</button>
                </div>
                <div class="flex gap-16" style="margin-bottom: 24px;">
<button class="btn btn-primary" id="btn-view-cards" onclick="setViewMode('cards')">üìä Cards</button>
    <button class="btn btn-secondary" id="btn-view-lista" onclick="setViewMode('lista')">üìÑ Lista</button>

    <!-- üîÑ BOT√ÉO NOVO -->
<button onclick="atualizarDoSmoobuViaDownload()">
  üîÑ Atualizar do Smoobu
</button>


                </div>
                <div id="view-cards"><div id="indicadores-gerais" class="indicadores-grid"></div></div>
                <div id="view-lista" style="display: none;">
                                      <div id="indicadores-lista" class="indicadores-grid"></div>
                    <div class="card">

    <!-- BARRA DE ROLAGEM SUPERIOR -->
    <div class="table-scroll-top" id="scrollTopFinanceiro">
        <div class="scroll-inner"></div>
    </div>

    <!-- TABELA -->
    <div class="table-container" id="scrollBottomFinanceiro">
        <div id="tabela-lista-financeira"></div>
    </div>

</div>


                </div>
            </div>


            <div id="analitica" class="page">
                <div class="page-header"><h2>Anal√≠tica</h2></div>
                <div class="card filter-bar">
                    <div class="form-group flex-1"><select id="filtroAnaliticaAnos" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroAnaliticaMeses" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroAnaliticaUnidades" class="form-select" multiple="multiple"></select></div>
                    <button class="btn btn-primary" onclick="renderAnalitica()">Aplicar</button>
                </div>
                <div class="analitica-cards">
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üí∞</div>
                            <div class="analitica-card-title">Receita</div>
                        </div>
                        <div class="analitica-card-value green" id="analitica-receita">R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-receita"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üì¶</div>
                            <div class="analitica-card-title">Reservas</div>
                        </div>
                        <div class="analitica-card-value" id="analitica-reservas">0</div>
                        <div class="analitica-card-chart"><canvas id="chart-reservas"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üí≥</div>
                            <div class="analitica-card-title">Comiss√£o</div>
                        </div>
                        <div class="analitica-card-value red" id="analitica-comissao">-R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-comissao-card"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üí∏</div>
                            <div class="analitica-card-title">Despesas</div>
                        </div>
                        <div class="analitica-card-value red" id="analitica-despesas">-R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-despesas-card"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üìà</div>
                            <div class="analitica-card-title">Lucro L√≠quido</div>
                        </div>
                        <div class="analitica-card-value green" id="analitica-lucro">R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-lucro"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px;">Receita por Unidade</h3>
                    <div style="height:300px;"><canvas id="chart-receita-unidade"></canvas></div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px;">Comiss√£o Portais por Unidade</h3>
                    <div style="height:300px;"><canvas id="chart-comissao"></canvas></div>
                </div>
            </div>


            <div id="despesas" class="page">
                <div class="page-header"><h2>Detalhes das Despesas</h2><button class="btn btn-primary" onclick="openDespesaModal()">+ Nova Despesa</button></div>
                <div class="card"><div class="table-container"><table id="tabela-despesas-detalhada"></table></div></div>
            </div>
            <div id="reservas" class="page">
                <div class="page-header"><h2>Gerador de Mensagem para Limpeza</h2></div>
                <div class="card"><div class="upload-area" onclick="document.getElementById('reservasFileInput').click()"><input type="file" id="reservasFileInput" accept=".xlsx,.xls" onchange="processarReservasFuturas(this.files[0])"><div style="font-size: 48px; margin-bottom: 16px;">üìÖ</div><h3>Selecione o arquivo de reservas futuras</h3></div></div>
                <div id="reservasPreview" style="display:none;"><div class="card"><div class="form-group"><label class="form-label">N√∫mero WhatsApp (com DDD)</label><input type="tel" id="whatsappLimpeza" class="form-input" placeholder="5585999999999"></div></div><div class="card"><h3>Preview da Mensagem</h3><pre id="mensagemPreview" style="background: #f5f5f5; padding: 20px; border-radius: 8px;"></pre><button class="btn btn-primary" style="margin-top: 16px;" onclick="enviarWhatsApp()">üì± Enviar via WhatsApp</button></div></div>
            </div>
            <div id="proprietarios" class="page">
                <div class="page-header"><h2>Gest√£o de Propriet√°rios</h2></div>
                <div class="card"><div id="proprietarios-list"></div><button class="btn btn-primary" style="margin-top: 16px;" onclick="salvarProprietarios()">Salvar Altera√ß√µes</button></div>
            </div>
            <div id="upload" class="page">
                <div class="page-header"><h2>Upload de Arquivo Smoobu</h2></div>
                <div class="card"><div class="upload-area">
<input type="file" id="fileInput" accept=".xlsx,.xls" onchange="processarEAdicionarDados(this.files[0])">


<div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div><h3>Selecione o arquivo de RESERVAS</h3><p>A receita ser√° contabilizada pela data de PARTIDA.</p></div></div>
            </div>
        </div>
    </div>
    <div id="despesaModal" class="modal-overlay">
        <div class="modal-content">
            <div class="page-header"><h3>Adicionar Nova Despesa</h3><button style="background:none; border:none; font-size: 24px; cursor:pointer;" onclick="closeDespesaModal()">&times;</button></div>
            <div class="form-group"><label class="form-label">Unidade</label><select id="despesaUnidade" class="form-select"></select></div>
            <div class="form-group"><label class="form-label">Descri√ß√£o</label><input type="text" id="despesaDescricao" class="form-input"></div>
            <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center;">
        Categoria
        <button type="button" class="btn btn-link" onclick="openCategoriaModal()">‚öôÔ∏è</button>
    </label>
    <select id="despesaCategoria" class="form-select"></select>
</div>

            <div class="form-group"><label class="form-label">Data</label><input type="date" id="despesaData" class="form-input"></div>
            <div class="form-group">
    <label class="form-label">Valor</label>
    <input
    type="text"
    id="despesaValor"
    class="form-input"
    placeholder="R$ 0,00"
    oninput="formatarValorBR(this)">

</div>

            <button class="btn btn-primary" style="width: 100%;" onclick="salvarDespesa()">Salvar Despesa</button>
        </div>
    </div>

<!-- MODAL DE CATEGORIAS -->
<div id="categoriaModal" class="modal-overlay">
    <div class="modal-content">
        <div class="page-header">
            <h3>Categorias de Despesa</h3>
            <button style="background:none;border:none;font-size:24px;cursor:pointer;"
                    onclick="closeCategoriaModal()">&times;</button>
        </div>

        <div class="form-group">
            <input type="text" id="novaCategoria" class="form-input" placeholder="Nova categoria">
            <button class="btn btn-primary"
                    style="margin-top:10px;width:100%;"
                    onclick="addCategoria()">Adicionar</button>
        </div>

        <div id="listaCategorias"></div>
    </div>
</div>


<script>
/* ===========================
   BANCO LOCAL (OBRIGAT√ìRIO)
=========================== */
let chartsAnalitica = {};
let currentViewMode = "cards";


const DB_RESERVAS = "DB_RESERVAS";
const DB_DESPESAS = "DB_DESPESAS";
const DB_PROPRIETARIOS = "DB_PROPRIETARIOS";
const DB_CATEGORIAS = "DB_CATEGORIAS";


function getDb(key) {
    try {
        return JSON.parse(localStorage.getItem(key)) || [];
    } catch (e) {
        console.error("Erro ao ler DB:", key, e);
        return [];
    }
}

function saveDb(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}

function formatCurrency(valor) {
    const numero = Number(valor) || 0;
    const abs = Math.abs(numero);

    const formatado = abs.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
    });

    return numero < 0 ? `-${formatado}` : formatado;
}



        function showPage(e,a){
            document.querySelectorAll(".page").forEach(e=>e.classList.remove("active")),
            document.querySelectorAll(".menu-item").forEach(e=>e.classList.remove("active")),
            document.getElementById(e).classList.add("active"),
            a&&a.classList.add("active"),
        "analitica"===e&&(setupAnaliticaFilters(),renderAnalitica()),
            "despesas"===e&&renderTabelaDespesasDetalhada(),
            "proprietarios"===e&&renderProprietarios()
        }

        function setViewMode(e){
            currentViewMode=e,
            document.getElementById("view-cards").style.display="cards"===e?"block":"none",
            document.getElementById("view-lista").style.display="lista"===e?"block":"none",
            document.getElementById("btn-view-cards").classList.toggle("btn-primary","cards"===e),
            document.getElementById("btn-view-cards").classList.toggle("btn-secondary","cards"!==e),
            document.getElementById("btn-view-lista").classList.toggle("btn-primary","lista"===e),
            document.getElementById("btn-view-lista").classList.toggle("btn-secondary","lista"!==e),
            renderViews()
        }
        
     function processarEAdicionarDados(e){
    if (!e) return;

    const reader = new FileReader();

    reader.onload = function (evt) {
        try {
            const workbook = XLSX.read(
                new Uint8Array(evt.target.result),
                { type: "array" }
            );

            const sheet = workbook.Sheets[workbook.SheetNames[0]];

           const dados = XLSX.utils.sheet_to_json(sheet)
    .map(linha => {

        // üîë ID √öNICO DA RESERVA (Smoobu)
        const idReserva = linha["Posi√ß√£o"];
        if (!idReserva) return null;

// üìÖ usa CHEGADA (REGRA CORRETA)
const data = parseDataBR(linha.Chegada || linha["Check-in"]);
if (!data) return null;

        // üí∞ S√ì CONTA SE TIVER PRE√áO
        const preco = parseFloat(linha.Pre√ßo || linha.Price || 0);
        if (!preco || preco <= 0) return null;

        // üßæ COMISS√ÉO (pode ser zero)
        const comissao = parseFloat(linha["Comiss√£o inclu√≠da"] || 0);

        return {
            idReserva: String(idReserva).trim(), // üëà ESSENCIAL
            unidade: (linha.Alojamento || linha.Accommodation || "N/A").trim(),
            ano: data.ano,
            mes: data.mes,
            mesAno: data.mesAno,
            receita: preco,
            comissao: comissao
        };
    })
    .filter(Boolean);



            if (dados.length === 0) {
                alert("‚ö†Ô∏è Nenhuma reserva v√°lida encontrada.");
                return;
            }

        const banco = getDb(DB_RESERVAS);

// üîí cria um set com IDs j√° existentes
const idsExistentes = new Set(
    banco.map(r => r.idReserva)
);

// üîé s√≥ entram reservas novas
const novos = dados.filter(r => !idsExistentes.has(r.idReserva));

if (novos.length === 0) {
    alert("‚ÑπÔ∏è Nenhuma reserva nova encontrada (duplicadas ignoradas)");
    return;
}

banco.push(...novos);
saveDb(DB_RESERVAS, banco);

alert(`‚úÖ ${novos.length} reservas novas importadas`);


            setupFilters();
            renderViews();

        } catch (err) {
            console.error(err);
            alert("‚ùå Erro ao processar arquivo");
        }
    };

    reader.readAsArrayBuffer(e);
}

        
       function setupFilters() {
    const dados = getDb(DB_RESERVAS);
    if (dados.length === 0) return;

    // üìÜ ANOS (YYYY)
    const anos = [...new Set(
        dados.map(e => e.mesAno.substring(0, 4))
    )].sort();

    // üìÖ MESES (MM)
    const meses = [...new Set(
        dados.map(e => e.mesAno.substring(5, 7))
    )].sort();

    // üè¢ UNIDADES
    const unidades = [...new Set(
        dados.map(e => e.unidade)
    )].sort();

    const selAno = document.getElementById("filtroAnos");
    const selMes = document.getElementById("filtroMeses");
    const selUn = document.getElementById("filtroUnidades");

    // üîπ ANOS
    selAno.innerHTML = anos
        .map(a => `<option value="${a}">${a}</option>`)
        .join("");

    // üîπ MESES (com nome)
    const nomesMeses = {
        "01": "Janeiro",
        "02": "Fevereiro",
        "03": "Mar√ßo",
        "04": "Abril",
        "05": "Maio",
        "06": "Junho",
        "07": "Julho",
        "08": "Agosto",
        "09": "Setembro",
        "10": "Outubro",
        "11": "Novembro",
        "12": "Dezembro"
    };

    selMes.innerHTML = meses
        .map(m => `<option value="${m}">${nomesMeses[m]}</option>`)
        .join("");

    // üîπ UNIDADES
    selUn.innerHTML = unidades
        .map(u => `<option value="${u}">${u}</option>`)
        .join("");

    // üîÑ Atualiza Select2
// üìÖ Define o ano atual como padr√£o
const anoAtual = new Date().getFullYear().toString();

if (anos.includes(anoAtual)) {
    $("#filtroAnos").val([anoAtual]);
}

    $("#filtroAnos").trigger("change");
    $("#filtroMeses").trigger("change");
    $("#filtroUnidades").trigger("change");
}


        
       function setupAnaliticaFilters() {
    const dados = getDb(DB_RESERVAS);

    const unidades = [...new Set(dados.map(e => e.unidade))].sort();
    const anos = [...new Set(dados.map(e => e.mesAno.substring(0, 4)))].sort();

    const meses = [
        { id: "01", text: "Janeiro" },
        { id: "02", text: "Fevereiro" },
        { id: "03", text: "Mar√ßo" },
        { id: "04", text: "Abril" },
        { id: "05", text: "Maio" },
        { id: "06", text: "Junho" },
        { id: "07", text: "Julho" },
        { id: "08", text: "Agosto" },
        { id: "09", text: "Setembro" },
        { id: "10", text: "Outubro" },
        { id: "11", text: "Novembro" },
        { id: "12", text: "Dezembro" }
    ];

    // üîπ recria Select2
    $("#filtroAnaliticaUnidades")
        .empty()
        .select2({ data: unidades, placeholder: "Todos os alojamentos" });

    $("#filtroAnaliticaAnos")
        .empty()
        .select2({ data: anos, placeholder: "Todos os anos" });

    $("#filtroAnaliticaMeses")
        .empty()
        .select2({ data: meses, placeholder: "Todos os meses" });

    // üü¢ SELECIONA O ANO ATUAL
    const anoAtual = new Date().getFullYear().toString();

    if (anos.includes(anoAtual)) {
        $("#filtroAnaliticaAnos")
            .val([anoAtual])
            .trigger("change");
    }
}

        
        function renderAnalitica(){
            try{
                let anosVal=$("#filtroAnaliticaAnos").val();
                let mesesVal=$("#filtroAnaliticaMeses").val();
                let unidadesVal=$("#filtroAnaliticaUnidades").val();
                
                const anos=Array.isArray(anosVal)?anosVal:(anosVal?[anosVal]:[]);
                const meses=Array.isArray(mesesVal)?mesesVal:(mesesVal?[mesesVal]:[]);
                const unidades=Array.isArray(unidadesVal)?unidadesVal:(unidadesVal?[unidadesVal]:[]);
                
                const passaNosFiltros=(registro,campoData)=>{
                    const ano=registro[campoData].substring(0,4);
                    const mes=registro[campoData].substring(5,7);
                    const unidade=registro.unidade;
                    
                    const passaAno=(anos.length===0||anos.includes(ano));
                    const passaMes=(meses.length===0||meses.includes(mes));
                    const passaUnidade=(unidades.length===0||unidades.includes(unidade));
                    
                    return passaAno&&passaMes&&passaUnidade;
                };
                
                const reservas=getDb(DB_RESERVAS).filter(e=>passaNosFiltros(e,"mesAno"));
                const despesas=getDb(DB_DESPESAS).filter(e=>passaNosFiltros(e,"data"));
                
                const receita=reservas.reduce((acc,e)=>acc+e.receita,0);
                const comissao=reservas.reduce((acc,e)=>acc+e.comissao,0);
                const despesasTotal=despesas.reduce((acc,e)=>acc+e.valor,0);
                const lucro=receita-comissao-despesasTotal;
                
                document.getElementById("analitica-receita").textContent=formatCurrency(receita);
                document.getElementById("analitica-receita").className="analitica-card-value green";
                document.getElementById("analitica-reservas").textContent=reservas.length;
                document.getElementById("analitica-comissao").textContent="-"+formatCurrency(comissao);
                document.getElementById("analitica-comissao").className="analitica-card-value red";
                document.getElementById("analitica-despesas").textContent="-"+formatCurrency(despesasTotal);
                document.getElementById("analitica-despesas").className="analitica-card-value red";
                document.getElementById("analitica-lucro").textContent=formatCurrency(lucro);
                document.getElementById("analitica-lucro").className=lucro>=0?"analitica-card-value green":"analitica-card-value red";
                
                renderAnaliticaCharts(reservas,despesas,anos,meses,unidades);
            }catch(err){
                console.error("Erro em renderAnalitica:",err);
            }
        }
        
        function renderAnaliticaCharts(reservas,despesas,anos,meses,unidades){
            Object.values(chartsAnalitica).forEach(chart=>{
                if(chart)chart.destroy();
            });
            chartsAnalitica={};
            
           const mapaMeses = {
    "01": "Jan", "02": "Fev", "03": "Mar", "04": "Abr",
    "05": "Mai", "06": "Jun", "07": "Jul", "08": "Ago",
    "09": "Set", "10": "Out", "11": "Nov", "12": "Dez"
};

const mesesComDados = {};
reservas.forEach(r => {
    const mes = r.mesAno.substring(5,7);
    if (!mesesComDados[mes]) mesesComDados[mes] = 0;
    mesesComDados[mes] += r.receita;
});

const mesesLabels = Object.keys(mesesComDados).sort();
const receitaPorMes = mesesLabels.map(m => mesesComDados[m]);

const labelsFormatados = mesesLabels.map(m => mapaMeses[m]);

            
            const ctxReceita=document.getElementById("chart-receita").getContext("2d");
            chartsAnalitica.receita=new Chart(ctxReceita,{
                type:"line",
                data:{
labels: mesesLabels,

                    datasets:[{
                        label:"Receita",
                        data:receitaPorMes,
                        borderColor:"#28a745",
                        backgroundColor:"rgba(40,167,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxReservas=document.getElementById("chart-reservas").getContext("2d");
            chartsAnalitica.reservas=new Chart(ctxReservas,{
                type:"doughnut",
                data:{
                    labels:["Reservas","Canceladas"],
                    datasets:[{
                        data:[reservas.length,0],
                        backgroundColor:["#2d7a7a","#dc3545"],
                        borderColor:["#1a4d4d","#c82333"],
                        borderWidth:2
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom"}}}
            });
            
            const ctxComissaoCard=document.getElementById("chart-comissao-card").getContext("2d");
            chartsAnalitica.comissaoCard=new Chart(ctxComissaoCard,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Comiss√£o",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            return reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.comissao,0);
                        }),
                        borderColor:"#dc3545",
                        backgroundColor:"rgba(220,53,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxDespesasCard=document.getElementById("chart-despesas-card").getContext("2d");
            chartsAnalitica.despesasCard=new Chart(ctxDespesasCard,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Despesas",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            return despesas.filter(e=>e.data.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.valor,0);
                        }),
                        borderColor:"#ffc107",
                        backgroundColor:"rgba(255,193,7,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxLucro=document.getElementById("chart-lucro").getContext("2d");
            chartsAnalitica.lucro=new Chart(ctxLucro,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Lucro",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            const rec=reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.receita,0);
                            const com=reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.comissao,0);
                            const des=despesas.filter(e=>e.data.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.valor,0);
                            return rec-com-des;
                        }),
                        borderColor:"#28a745",
                        backgroundColor:"rgba(40,167,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const unidadesUnicas=[...new Set(reservas.map(e=>e.unidade))];
            const receitaPorUnidade=unidadesUnicas.map(u=>reservas.filter(e=>e.unidade===u).reduce((acc,e)=>acc+e.receita,0));
            
            const ctxUnidade=document.getElementById("chart-receita-unidade").getContext("2d");
            chartsAnalitica.unidade=new Chart(ctxUnidade,{
                type:"bar",
                data:{
                    labels:unidadesUnicas,
                    datasets:[{
                        label:"Receita por Unidade",
                        data:receitaPorUnidade,
                        backgroundColor:"#2d7a7a",
                        borderColor:"#1a4d4d",
                        borderWidth:1
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const comissaoPorUnidade=unidadesUnicas.map(u=>reservas.filter(e=>e.unidade===u).reduce((acc,e)=>acc+e.comissao,0));
            
            const ctxComissao=document.getElementById("chart-comissao").getContext("2d");
            chartsAnalitica.comissao=new Chart(ctxComissao,{
                type:"pie",
                data:{
                    labels:unidadesUnicas,
                    datasets:[{
                        data:comissaoPorUnidade,
                        backgroundColor:["#2d7a7a","#d4a574","#dc3545","#28a745","#ffc107","#17a2b8"],
                        borderColor:["#1a4d4d","#b8864f","#c82333","#1e7e34","#e0a800","#0c5460"],
                        borderWidth:2
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom"}}}
            });
        }
        
        function renderViews(){
            try{
                let anosVal=$("#filtroAnos").val();
                let mesesVal=$("#filtroMeses").val();
                let unidadesVal=$("#filtroUnidades").val();
                
                const anos=Array.isArray(anosVal)?anosVal:(anosVal?[anosVal]:[]);
                const meses=Array.isArray(mesesVal)?mesesVal:(mesesVal?[mesesVal]:[]);
                const unidades=Array.isArray(unidadesVal)?unidadesVal:(unidadesVal?[unidadesVal]:[]);
                
                let anosFinais=anos;
             
                const passaNosFiltros=(registro,campoData)=>{
                    const ano=registro[campoData].substring(0,4);
                    const mes=registro[campoData].substring(5,7);
                    const unidade=registro.unidade;
                    
                    const passaAno=(anosFinais.length===0||anosFinais.includes(ano));
                    const passaMes=(meses.length===0||meses.includes(mes));
                    const passaUnidade=(unidades.length===0||unidades.includes(unidade));
                    
                    return passaAno&&passaMes&&passaUnidade;
                };
                
                const reservas=getDb(DB_RESERVAS).filter(e=>passaNosFiltros(e,"mesAno"));
                const despesas=getDb(DB_DESPESAS).filter(e=>passaNosFiltros(e,"data"));
                
                if("cards"===currentViewMode){
                    renderCardsView(reservas,despesas);
                }else{
                    renderListaView(reservas,despesas,unidades,anosFinais,meses);
                }
            }catch(err){
                console.error("Erro em renderViews:",err);
                alert("Erro ao processar filtros: "+err.message);
            }
        }
        
        function renderCardsView(e,a){
            const t=e.reduce((e,a)=>e+a.receita,0),
                  s=e.reduce((e,a)=>e+a.comissao,0),
                  r=a.reduce((e,a)=>e+a.valor,0),
                  o=t-s-r;
            document.getElementById("indicadores-gerais").innerHTML=`
                <div class="indicador-card"><div class="indicador-label">Receita Total</div><div class="indicador-valor green">${formatCurrency(t)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Comiss√£o Portais</div><div class="indicador-valor red">-${formatCurrency(s)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Total de Reservas</div><div class="indicador-valor">${e.length}</div></div>
                <div class="indicador-card clickable" onclick="showPage('despesas', document.querySelector('.menu-item[onclick*=\\'despesas\\']'))"><div class="indicador-label">Despesas</div><div class="indicador-valor red">-${formatCurrency(r)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Lucro L√≠quido</div><div class="indicador-valor green">${formatCurrency(o)}</div></div>
            `
        }
        
        function renderListaView(e,a,t,s,r){
            const o=document.getElementById("tabela-lista-financeira"),
                  n=t.length>0?t:[...new Set(getDb(DB_RESERVAS).map(e=>e.unidade))].sort(),
                  l=1===s.length?s[0]:(new Date).getFullYear().toString(),
                  d=r.length>0?r.sort():["01","02","03","04","05","06","07","08","09","10","11","12"],
                  i=["Receita Total","Comiss√£o Portais","Despesas","Lucro"];
            
            const receitaTotal=e.reduce((acc,item)=>acc+item.receita,0),
                  comissaoTotal=e.reduce((acc,item)=>acc+item.comissao,0),
                  despesasTotal=a.reduce((acc,item)=>acc+item.valor,0),
                  lucroTotal=receitaTotal-comissaoTotal-despesasTotal;
            
            document.getElementById("indicadores-lista").innerHTML=`
                <div class="indicador-card"><div class="indicador-label">Receita Total</div><div class="indicador-valor green">${formatCurrency(receitaTotal)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Comiss√£o Portais</div><div class="indicador-valor red">-${formatCurrency(comissaoTotal)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Despesas</div><div class="indicador-valor red">-${formatCurrency(despesasTotal)}</div></div>
                <div class="indicador-card"><div class="indicador-label">Lucro L√≠quido</div><div class="indicador-valor green">${formatCurrency(lucroTotal)}</div></div>
            `;
            
            let c=``;
            n.forEach(t=>{
                c+=`<div class="unidade-grupo">
                    <div class="unidade-header" onclick="toggleUnidade('${t.replace(/\s+/g,'_')}')">
                        <div class="unidade-nome">
                            <span class="unidade-toggle" id="toggle_${t.replace(/\s+/g,'_')}">‚ñº</span>
                            ${t}
                        </div>
                    </div>
                    <div class="unidade-conteudo" id="conteudo_${t.replace(/\s+/g,'_')}">
                        <table>
                            <thead><tr><th>Tipo</th>${d.map(e=>`<th>${e}/${l.substring(2)}</th>`).join("")}</tr></thead>
                            <tbody>`;
             i.forEach((tipo)=>{
if (tipo === "Despesas") {

    c += `
        <tr style="color:#2d7a7a;font-weight:600;">
            <td>
                <span id="arrow_${t.replace(/\s+/g,'_')}_${l}">‚ñ∂</span>
                Despesas
            </td>
    `;

    d.forEach(mes => {
        const totalMes = a
            .filter(x => x.unidade === t && x.data.startsWith(`${l}-${mes}`))
            .reduce((acc, x) => acc + x.valor, 0);

        const key = `desp_${t.replace(/\s+/g,'_')}_${l}_${mes}`;

        c += `
            <td class="red" style="cursor:pointer"
                onclick="toggleDespesasLinha('${key}','${t}','${l}','${mes}','arrow_${t.replace(/\s+/g,'_')}_${l}')">
                ${formatCurrency(-totalMes)}

            </td>
        `;
    });

    c += `</tr>`;

    d.forEach(mes => {
        const key = `desp_${t.replace(/\s+/g,'_')}_${l}_${mes}`;
        c += `
            <tr id="${key}" style="display:none;background:#f9f9f9;">
                <td colspan="${d.length + 1}">
                    <div id="${key}_conteudo" style="padding:12px;"></div>
                </td>
            </tr>
        `;
    });

    return;
}


    // üîπ LINHAS NORMAIS (Receita, Comiss√£o, Lucro)
    c += `<tr><td>${tipo}</td>`;

    d.forEach(mes=>{
        const n = `${l}-${mes}`;
        const reservasMes = e.filter(x => x.unidade === t && x.mesAno === n);
        const despesasMes = a.filter(x => x.unidade === t && x.data.startsWith(n));

        let valor = 0;
        if (tipo === "Receita Total") valor = reservasMes.reduce((acc,x)=>acc+x.receita,0);
        else if (tipo === "Comiss√£o Portais") valor = -reservasMes.reduce((acc,x)=>acc+x.comissao,0);
        else if (tipo === "Lucro")
            valor =
                reservasMes.reduce((acc,x)=>acc+x.receita,0)
              - reservasMes.reduce((acc,x)=>acc+x.comissao,0)
              - despesasMes.reduce((acc,x)=>acc+x.valor,0);

        c += `<td class="${valor<0?'red':''}">${formatCurrency(valor)}</td>`;
    });

    c += `</tr>`;


                });
                c+=`</tbody></table></div></div>`
            });
                       o.innerHTML = c

            requestAnimationFrame(sincronizarScrollFinanceiro);
        }



        
        function toggleUnidade(unidadeId){
            const conteudo=document.getElementById(`conteudo_${unidadeId}`),
                  toggle=document.getElementById(`toggle_${unidadeId}`);
            conteudo.classList.toggle('collapsed'),
            toggle.classList.toggle('collapsed')
        }
        
       function renderTabelaDespesasDetalhada() {
    const despesas = getDb(DB_DESPESAS);
    const tabela = document.getElementById("tabela-despesas-detalhada");

    let html = `
        <thead>
            <tr>
                <th>Descri√ß√£o</th>
                <th>Pr√©dio</th>
                <th>Categoria</th>
                <th>Data</th>
                <th>Valor</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
    `;

    if (despesas.length === 0) {
        html += `
            <tr>
                <td colspan="6" style="text-align:center;padding:20px;">
                    Nenhuma despesa cadastrada.
                </td>
            </tr>
        `;
    } else {
        despesas
            .sort((a, b) => new Date(b.data) - new Date(a.data))
            .forEach(d => {
                html += `
                    <tr>
                        <td>${d.descricao}</td>
                        <td>${d.unidade}</td>
                        <td>${d.categoria}</td>
                        <td>${new Date(d.data).toLocaleDateString("pt-BR")}</td>
                        <td>${formatCurrency(d.valor)}</td>
                        <td style="display:flex;gap:12px;align-items:center;">
    <span 
        style="cursor:pointer;font-size:18px;" 
        title="Editar"
        onclick="editarDespesa('${d.id}')">
        ‚úèÔ∏è
    </span>

    <span 
        style="cursor:pointer;font-size:18px;color:#dc3545;" 
        title="Excluir"
        onclick="excluirDespesa('${d.id}')">
        üóëÔ∏è
    </span>
</td>

                    </tr>
                `;
            });
    }

    html += "</tbody>";
    tabela.innerHTML = html;
}

        
function openDespesaModal() {
    carregarUnidadesDespesa();
    carregarCategoriasDespesa();

    document.getElementById("despesaModal").classList.add("active");

    // N√ÉO zera despesaEmEdicao aqui
    if (!despesaEmEdicao) {
        document.getElementById("despesaUnidade").value = "";
        document.getElementById("despesaDescricao").value = "";
        document.getElementById("despesaCategoria").value = "";
        document.getElementById("despesaData").value = "";
        document.getElementById("despesaValor").value = "";

        document.querySelector("#despesaModal button.btn-primary").textContent =
            "Salvar Despesa";
    }
}


        
        function closeDespesaModal(){
            document.getElementById("despesaModal").classList.remove("active")
        }
        
        function salvarDespesa() {

    const despesas = getDb(DB_DESPESAS);

    const valorNumerico = parseFloat(
        $("#despesaValor").val()
            .replace("R$", "")
            .replace(/\./g, "")
            .replace(",", ".")
    );

 if (
    !$("#despesaUnidade").val() ||
    !$("#despesaDescricao").val() ||
    !$("#despesaCategoria").val() ||
    !$("#despesaData").val() ||
    isNaN(valorNumerico)
) {
    alert("‚ö†Ô∏è Preencha todos os campos!");
    return;
}


if (despesaEmEdicao !== null) {
    // ‚úèÔ∏è EDITAR EXISTENTE
    despesas[despesaEmEdicao] = {
        ...despesas[despesaEmEdicao],
        unidade: $("#despesaUnidade").val(),
        descricao: $("#despesaDescricao").val(),
        categoria: $("#despesaCategoria").val(),
        data: $("#despesaData").val(),
        valor: valorNumerico
    };
} else {
    // ‚ûï NOVA
    despesas.push({
        id: `desp_${Date.now()}`,
        unidade: $("#despesaUnidade").val(),
        descricao: $("#despesaDescricao").val(),
        categoria: $("#despesaCategoria").val(),
        data: $("#despesaData").val(),
        valor: valorNumerico
    });
}


    saveDb(DB_DESPESAS, despesas);

    despesaEmEdicao = null;

    closeDespesaModal();
    renderViews();
renderTabelaDespesasDetalhada();

}

        
        function excluirDespesa(e){
            if(!confirm("Tem certeza?"))return;
            saveDb(DB_DESPESAS,getDb(DB_DESPESAS).filter(a=>a.id!==e)),renderTabelaDespesasDetalhada(),renderViews()
        }
        
        function zerarFinanceiro(){
            confirm("ATEN√á√ÉO! Apagar√° TUDO. Deseja continuar?")&&(localStorage.removeItem(DB_RESERVAS),localStorage.removeItem(DB_DESPESAS),localStorage.removeItem(DB_PROPRIETARIOS),alert("Todos os dados foram zerados."),showPage("financeiro",document.querySelector('.menu-item[onclick*="financeiro"]')))
        }
        
        function processarReservasFuturas(e){
            if(!e)return;
            const a=new FileReader;
            a.onload=function(t){
                try{
                    const e=XLSX.read(new Uint8Array(t.target.result),{type:"array",cellDates:!0}),s=XLSX.utils.sheet_to_json(e.Sheets[e.SheetNames[0]]),r={};
                    s.forEach(e=>{const a=e.Alojamento||e.Accommodation;a&&(r[a]||(r[a]=[]),r[a].push({hospede:e.H√≥spede||e.Guest||"N/A",chegada:(new Date(e.Chegada||e["Check-in"])).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}),partida:(new Date(e.Partida||e["Check-out"])).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}),pessoas:parseInt(e.Adultos||0)+parseInt(e.Crian√ßas||0)||1}))});
                    const o=Object.values(r)[0]?.[0];
                    if(!o)return void alert("Nenhuma reserva encontrada.");
                    const[,n]=o.chegada.split("/"),l=["JANEIRO","FEVEREIRO","MAR√áO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"][parseInt(n)-1];
                    let d=`üü¶ ${l} ${(new Date).getFullYear()}\n\n`;
                    Object.keys(r).sort().forEach(e=>{d+=`üè¢ ${e}\n\n`,r[e].forEach(e=>{d+=`${e.chegada} a ${e.partida} ‚Ä¢ ${e.hospede} ‚Ä¢ ${e.pessoas} pessoas\n`}),d+="\n"}),
                    document.getElementById("mensagemPreview").textContent=d,document.getElementById("reservasPreview").style.display="block"
                }catch(e){alert("‚ùå Erro ao processar o arquivo: "+e.message)}
            },a.readAsArrayBuffer(e)
        }
        
        function enviarWhatsApp(){
            const e=document.getElementById("whatsappLimpeza").value;
            e?window.open(`https://wa.me/${e}?text=${encodeURIComponent(document.getElementById("mensagemPreview").textContent)}`,"_blank"):alert("‚ö†Ô∏è Digite o n√∫mero do WhatsApp!")
        }
        
        function renderProprietarios(){
            const e=getDb(DB_PROPRIETARIOS),a=[...new Set(getDb(DB_RESERVAS).map(e=>e.unidade))].sort();
            let t="";
            a.forEach(a=>{const s=e.find(e=>e.unidade===a)||{};t+=`<div class="card"><div class="form-group"><label class="form-label" style="font-weight: bold;">${a}</label><input type="text" class="form-input prop-input" data-unidade="${a}" value="${s.nome||""}" placeholder="Nome do propriet√°rio"></div></div>`}),
            document.getElementById("proprietarios-list").innerHTML=t||"<p>Nenhuma unidade encontrada. Importe um arquivo de reservas primeiro.</p>"
        }
        
        function salvarProprietarios(){
            const e=document.querySelectorAll(".prop-input"),a=Array.from(e).map(e=>({unidade:e.dataset.unidade,nome:e.value.trim()})).filter(e=>e.nome);
            saveDb(DB_PROPRIETARIOS,a),alert("‚úÖ Propriet√°rios salvos com sucesso!")
        }
        
        $(document).ready(function () {
$("#filtroAnos").select2({
    placeholder: "Filtrar por ano",
    allowClear: true
});

$("#filtroMeses").select2({
    placeholder: "Filtrar por m√™s",
    allowClear: true
});

$("#filtroUnidades").select2({
    placeholder: "Filtrar por unidade",
    allowClear: true
});


    // üîß inicializa filtros UMA √öNICA VEZ

    showPage("financeiro", document.querySelector('.menu-item[onclick*="financeiro"]'));
    setViewMode("cards");

// üëá GATILHO AUTOM√ÅTICO (1 vez por sess√£o)
    // üîÑ ATUALIZA AUTOM√ÅTICA ‚Äî 1¬™ vez do dia
    if (!jaAtualizouHoje()) {
        atualizarDoSmoobuViaDownload("auto");
    }
    carregarCategoriasDespesa();
 
});
      
function getSmoobuCsvUrlAnoAtual() {
    const ano = new Date().getFullYear();

    return (
        "https://login.smoobu.com/api/v2/users/670124/bookings/exports/csv" +
        "?sort=-createdAt" +
        `&filter[arrivalDate][from]=${ano}-01-01` +
        `&filter[arrivalDate][to]=${ano}-12-31` +
        "&filter[includeIntersections]=true" +
        "&filter[excludeMockedBookings]=true" +
        "&filter[statuses][0]=1"
    );
}

function jaAtualizouHoje() {
    const hoje = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    return localStorage.getItem("smoobuAtualizadoEm") === hoje;
}

function marcarAtualizadoHoje() {
    const hoje = new Date().toISOString().slice(0, 10);
    localStorage.setItem("smoobuAtualizadoEm", hoje);
}


function atualizarDoSmoobuViaDownload(motivo = "manual") {

    // 1Ô∏è‚É£ Abre o Smoobu
    window.open(getSmoobuCsvUrlAnoAtual(), "_blank");

    // 2Ô∏è‚É£ Se foi autom√°tico (primeira vez do dia), marca no sistema
    if (motivo === "auto") {
        marcarAtualizadoHoje();
    }

    // 3Ô∏è‚É£ Leva para a tela de Upload
    showPage("upload", document.querySelector('.menu-item[onclick*="upload"]'));

    // 4Ô∏è‚É£ Apenas destaca onde subir o arquivo
    setTimeout(() => {
        const input = document.getElementById("fileInput");
        if (input) {
            input.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }, 500);
}



function parseDataBR(valor) {
    if (!valor) return null;

    // üü¢ Se vier como Date do Excel
    if (valor instanceof Date && !isNaN(valor)) {
        const ano = valor.getFullYear();
        const mes = String(valor.getMonth() + 1).padStart(2, "0");

        return {
            ano: String(ano),
            mes: mes,
            mesAno: `${ano}-${mes}`
        };
    }

    // üü° Se vier como texto "dd/mm/aa" ou "dd/mm/aaaa"
    if (typeof valor === "string") {
        const partes = valor.split("/");
        if (partes.length !== 3) return null;

        let dia = partes[0];
        let mes = partes[1];
        let ano = partes[2];

        if (ano.length === 2) {
            ano = "20" + ano;
        }

        return {
            ano: ano,
            mes: mes.padStart(2, "0"),
            mesAno: `${ano}-${mes.padStart(2, "0")}`
        };
    }

    return null;
}

function openCategoriaModal() {
    document.getElementById("categoriaModal").classList.add("active");
    renderCategorias();
}

function closeCategoriaModal() {
    document.getElementById("categoriaModal").classList.remove("active");
}

function addCategoria() {
    const input = document.getElementById("novaCategoria");
    const nome = input.value.trim();
    if (!nome) return;

    const categorias = getDb(DB_CATEGORIAS);
    if (!categorias.includes(nome)) {
        categorias.push(nome);
        saveDb(DB_CATEGORIAS, categorias);
    }

    input.value = "";

    // üîÑ atualiza lista do modal
    renderCategorias();

    // üîÑ atualiza SELECT da despesa imediatamente ‚úÖ
    const selectCategoria = document.getElementById("despesaCategoria");
    selectCategoria.innerHTML =
        '<option value="">Selecione a categoria</option>' +
        categorias.map(c => `<option value="${c}">${c}</option>`).join("");

    // j√° seleciona a categoria rec√©m-criada
    selectCategoria.value = nome;
}

function renderCategorias() {
    const lista = document.getElementById("listaCategorias");
    const categorias = getDb(DB_CATEGORIAS);

    lista.innerHTML = categorias.map(c =>
        `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
            <span>${c}</span>
            <button class="btn btn-link" style="color:red;" onclick="removeCategoria('${c}')">Excluir</button>
        </div>`
    ).join("");
}

function removeCategoria(nome) {
    saveDb(DB_CATEGORIAS, getDb(DB_CATEGORIAS).filter(c => c !== nome));
    renderCategorias();
}

function formatarValorBR(input) {
    let valor = input.value.replace(/\D/g, "");

    if (!valor) {
        input.value = "";
        return;
    }

    valor = (parseInt(valor, 10) / 100).toFixed(2);

    input.value = valor
        .replace(".", ",")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    
    input.value = "R$ " + input.value;
}

function abrirDespesasDetalhe(unidade, ano, mes) {

    const despesas = getDb(DB_DESPESAS).filter(d =>
        d.unidade === unidade &&
        d.data.startsWith(`${ano}-${mes}`)
    );

    let html = `
        <thead>
            <tr>
                <th>Data</th>
                <th>Descri√ß√£o</th>
                <th>Categoria</th>
                <th>Valor</th>
            </tr>
        </thead>
        <tbody>
    `;

    if (despesas.length === 0) {
        html += `
            <tr>
                <td colspan="4" style="text-align:center;padding:20px;">
                    Nenhuma despesa encontrada.
                </td>
            </tr>
        `;
    } else {
        despesas.forEach(d => {
            html += `
                <tr>
                    <td>${new Date(d.data).toLocaleDateString("pt-BR")}</td>
                    <td>${d.descricao}</td>
                    <td>${d.categoria}</td>
                    <td>${formatCurrency(d.valor)}</td>
                </tr>
            `;
        });
    }

    html += "</tbody>";

    // reutiliza a tabela de despesas (sem criar modal novo ainda)
    showPage("despesas", document.querySelector('.menu-item[onclick*="despesas"]'));
    document.getElementById("tabela-despesas-detalhada").innerHTML = html;
}

function toggleDespesasLinha(key, unidade, ano, mes, arrowId) {

    const linha = document.getElementById(key);
    const conteudo = document.getElementById(key + "_conteudo");
    const arrow = document.getElementById(arrowId);

    const aberta = linha.style.display === "table-row";

    // fecha todas as outras
    document.querySelectorAll("tr[id^='desp_']").forEach(l => {
        l.style.display = "none";
    });
    document.querySelectorAll("[id^='arrow_']").forEach(a => {
        a.textContent = "‚ñ∂";
    });

    if (aberta) {
        arrow.textContent = "‚ñ∂";
        return;
    }

    const prefixo = `${ano}-${mes}`;

    const despesas = getDb(DB_DESPESAS).filter(d =>
        d.unidade === unidade &&
        d.data.startsWith(prefixo)
    );

    let html = `
        <table style="width:100%;border-collapse:collapse;">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th>Categoria</th>
                    <th style="text-align:right;">Valor</th>
                </tr>
            </thead>
            <tbody>
    `;

    if (despesas.length === 0) {
        html += `
            <tr>
                <td colspan="4" style="text-align:center;padding:12px;">
                    Nenhuma despesa cadastrada neste m√™s.
                </td>
            </tr>
        `;
    } else {
        despesas.forEach(d => {
            html += `
                <tr>
                    <td>${new Date(d.data).toLocaleDateString("pt-BR")}</td>
                    <td>${d.descricao}</td>
                    <td>${d.categoria}</td>
                    <td style="text-align:right;">${formatCurrency(d.valor)}</td>
                </tr>
            `;
        });
    }

    html += "</tbody></table>";

    conteudo.innerHTML = html;
    linha.style.display = "table-row";
    arrow.textContent = "‚ñº";
}

function editarDespesa(id) {

    const despesas = getDb(DB_DESPESAS);
    const index = despesas.findIndex(d => d.id === id);
    if (index === -1) return;

    // guarda √≠ndice, n√£o o objeto solto
    despesaEmEdicao = index;

    const d = despesas[index];

    openDespesaModal();

    document.getElementById("despesaUnidade").value = d.unidade;
    document.getElementById("despesaDescricao").value = d.descricao;
    document.getElementById("despesaCategoria").value = d.categoria;
    document.getElementById("despesaData").value = d.data;

    const inputValor = document.getElementById("despesaValor");
    inputValor.value = "R$ " + d.valor
        .toFixed(2)
        .replace(".", ",")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ".");

    document.querySelector("#despesaModal button.btn-primary").textContent =
        "Salvar Altera√ß√µes";
}

function carregarUnidadesDespesa() {
    const select = document.getElementById("despesaUnidade");

    // pega unidades das reservas
    const unidades = [
        ...new Set(getDb(DB_RESERVAS).map(r => r.unidade))
    ].sort();

    select.innerHTML = '<option value="">Selecione a unidade</option>';

    unidades.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        select.appendChild(opt);
    });
}

function carregarCategoriasDespesa() {
    const select = document.getElementById("despesaCategoria");
    const categorias = getDb(DB_CATEGORIAS);

    select.innerHTML = '<option value="">Selecione a categoria</option>';

    categorias.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });
}


function sincronizarScrollFinanceiro() {
    const scrollTop = document.getElementById("scrollTopFinanceiro");
    const scrollBottom = document.getElementById("scrollBottomFinanceiro");

    if (!scrollTop || !scrollBottom) return;

    const largura = scrollBottom.scrollWidth;
    const visivel = scrollBottom.clientWidth;

    // S√≥ mostra a barra superior se houver o que rolar
    if (largura > visivel) {
        scrollTop.style.display = "block";
        scrollTop.querySelector(".scroll-inner").style.width = largura + "px";
    } else {
        scrollTop.style.display = "none";
    }

    scrollTop.onscroll = () => {
        scrollBottom.scrollLeft = scrollTop.scrollLeft;
    };

    scrollBottom.onscroll = () => {
        scrollTop.scrollLeft = scrollBottom.scrollLeft;
    };
}


    </script>
</body>
</html>
